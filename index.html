<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Document</title>
        <style>
body {
    display: flex;
    flex-direction: column;
    height: 80vh;
}

      .compass {
          position: relative;
          width: 320px;
          height: 320px;
          border-radius: 50%;
          box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
          margin: auto;
      }

      .compass > .compass-circle {
          position: absolute;
          width: 80%;
          height: 80%;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          transition: transform 0.1s ease-out;
          background-image: "https://cdn3.iconfinder.com/data/icons/glypho-travel/64/gps-navi-arrow-512.png";
          background-size: contain;
      }

      .compass > .my-point {
          position: absolute;
          opacity: 100;
          width: 20%;
          height: 20%;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          transition: transform 0.1s ease-out;
          background: rgb(223, 200, 69);
          border-radius: 50%;
          transition: opacity 0.5s ease-out;
      }

      .start-btn {
          margin-bottom: auto;
      }
        </style>
    </head>
    <body>
        <div class="compass">
            <div class="compass-circle"></div>
            <div class="my-point"></div>
        </div>
        <button class="start-btn">Use portrait mode, click me, then follow the green dot.</button>
    </body>
    <script>
const compassCircle = document.querySelector(".compass-circle");
const myPoint = document.querySelector(".my-point");
const startButton = document.querySelector(".start-btn");
const isIOS = navigator.userAgent.match(/(iPod|iPhone|iPad)/) && navigator.userAgent.match(/AppleWebKit/);

function init() {
    startButton.addEventListener('click', startCompass);
    navigator.geolocation.getCurrentPosition(locationHandler);

    if (!isIOS) {
        window.addEventListener("deviceorientationabsolute", handler, true);
    } else { 
        //compassCircle.style.display = 'none';
    }
}

function startCompass() {
    if (isIOS) {
        DeviceOrientationEvent.requestPermission()
            .then((response) => {
                if (response === "granted") {
                    window.addEventListener("deviceorientation", handler, true);
                    //compassCircle.style.display = 'default';
                } else {
                    alert("has to be allowed!");
                }
            })
            .catch(() => alert("not supported"));
    }
    startButton.style.display = "none";
}

function handler(e) {
    compass = e.webkitCompassHeading || Math.abs(e.alpha - 360);
    compassCircle.style.transform = `translate(-50%, -50%) rotate(${-compass+pointDegree}deg)`;

    // Â±15 degree
    if (
        (pointDegree < Math.abs(compass) &&
            pointDegree + 15 > Math.abs(compass)) ||
        pointDegree > Math.abs(compass + 15) ||
        pointDegree < Math.abs(compass)
    ) {
        //myPoint.style.opacity = 0;
        myPoint.style.background = 'rgb(233, 30, 69)';
    } else if (pointDegree) {
        //myPoint.style.opacity = 1;
        myPoint.style.background = 'rgb(8, 223, 69)';
    }
}

let pointDegree;

function locationHandler(position) {
    const { latitude, longitude } = position.coords;
    pointDegree = calcDegreeToPoint(latitude, longitude);

    if (pointDegree < 0) {
        pointDegree = pointDegree + 360;
    }
}

function calcDegreeToPoint(latitude, longitude) {
    const [ lat, lng ] = [ 37.46257496344394, -122.27192064251669 ];

    const phiK = (lat * Math.PI) / 180.0;
    const lambdaK = (lng * Math.PI) / 180.0;
    const phi = (latitude * Math.PI) / 180.0;
    const lambda = (longitude * Math.PI) / 180.0;
    const psi =
        (180.0 / Math.PI) *
        Math.atan2(
            Math.sin(lambdaK - lambda),
            Math.cos(phi) * Math.tan(phiK) -
            Math.sin(phi) * Math.cos(lambdaK - lambda)
        );
    return Math.round(psi);
}

init();
    </script>
</html>


